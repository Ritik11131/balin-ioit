<div class="container mx-auto max-w-4xl h-full flex flex-col overflow-hidden">

  <!-- Vehicle Header -->
  <div class="flex justify-between items-center mb-6 shrink-0">
    <div class="flex items-center gap-3 group">
      <span [ngClass]="vehicle | vehicleStatus"
        class="relative w-2.5 h-2.5 rounded-full transition-all duration-300 group-hover:scale-110">
        <span [ngClass]="vehicle | vehicleStatus"
          class="absolute top-0 left-0 w-full h-full rounded-full opacity-75 animate-ping"></span>
      </span>
      <span class="text-lg font-semibold text-gray-800 group-hover:text-gray-900">
        {{ vehicle?.name || 'Loading...' }}
      </span>
    </div>
    <div>
      <p-button icon="pi pi-ellipsis-v" [outlined]="true" (click)="menu.toggle($event)"></p-button>
      <p-tieredMenu appendTo="body" #menu [model]="(menuItems$ | async) ?? []" [popup]="true"></p-tieredMenu>
    </div>
  </div>

  <!-- Tabs Section -->
  <div class="flex-1 overflow-hidden">

    <p-tabs [(value)]="activeTabIndex" class="h-full flex flex-col">
      <p-tablist>
        <p-tab value="overview">Overview</p-tab>
        <p-tab value="sensors">Sensors</p-tab>
      </p-tablist>

      <p-tabpanels class="flex-1 overflow-hidden">

        <p-tabpanel value="overview" class="h-full flex flex-col overflow-auto relative">

  <!-- Scrollable content above iframe -->
  <div class="text-sm mt-4 pb-40"> <!-- add bottom padding to avoid overlap with iframe -->
    <ng-container *ngIf="vehicle; else skeletonOverview">

      <!-- Updated -->
      <div class="flex justify-between items-center px-4 py-3 border-b border-gray-100">
        <span class="font-medium text-gray-500">Updated</span>
        <span class="text-gray-800 font-semibold">{{ vehicle.lastUpdated | timeAgo }}</span>
      </div>

      <!-- Address -->
      <div class="flex justify-between items-center px-4 py-3 border-b border-gray-100">
        <span class="font-medium text-gray-500">Address</span>
        <span class="text-gray-800 font-semibold">{{ vehicle.address || 'â€”' }}</span>
      </div>

      <!-- Speed -->
      <div class="flex justify-between items-center px-4 py-3 border-b border-gray-100">
        <span class="font-medium text-gray-500">Speed</span>
        <span class="text-gray-800">
          <span class="font-semibold">{{ vehicle?.apiObject?.position?.speed || 0 }}</span> km/h
        </span>
      </div>

      <!-- Odometer -->
      <div class="flex justify-between items-center px-4 py-3">
        <span class="font-medium text-gray-500">Odometer</span>
        <span class="text-gray-800">
          <span class="font-semibold">
            {{ ((vehicle?.apiObject?.device?.details?.lastOdometer) / 1000)?.toFixed(3) || 0 }}
          </span> km
        </span>
      </div>

    </ng-container>
  </div>

  <div class="fixed bottom-0 left-0 w-full max-w-4xl mx-auto bg-gray-100 border-t z-50">
    <span class="text-lg font-semibold px-4 py-2 block border-b">
      Live From Vehicle
    </span>
    <iframe [src]="iframeUrl"
      allow="microphone; camera; geolocation; autoplay; encrypted-media"
      class="w-full h-80"
      allowfullscreen loading="lazy"
      referrerpolicy="no-referrer-when-downgrade"></iframe>
  </div>
  <!-- Fixed iframe at bottom -->

</p-tabpanel>




        <!-- Sensors Tab -->
        <p-tabpanel value="sensors" class="h-full overflow-y-auto">
          <div class="text-sm mt-4">
            <ng-container *ngIf="vehicle as d; else skeletonSensors">

              <!-- Row -->
              <div class="flex justify-between items-center px-4 py-3 border-b last:border-none">
                <span class="font-medium text-gray-500">Power</span>
                <span class="text-gray-800 font-semibold">{{ d.apiObject?.position?.ign ? 'On' : 'Off' }}</span>
              </div>

              <div class="flex justify-between items-center px-4 py-3 border-b last:border-none">
                <span class="font-medium text-gray-500">External Battery</span>
                <span class="text-gray-800 font-semibold">{{ d.apiObject?.position?.extVolt }} <span
                    class="font-normal">V</span></span>
              </div>

              <div class="flex justify-between items-center px-4 py-3 border-b last:border-none">
                <span class="font-medium text-gray-500">Internal Battery</span>
                <span class="text-gray-800 font-semibold">{{ d.apiObject?.position?.battPer }}<span
                    class="font-normal">%</span></span>
              </div>

              <div class="flex justify-between items-center px-4 py-3 border-b last:border-none">
                <span class="font-medium text-gray-500">SOS</span>
                <span class="text-gray-800 font-semibold">{{ d?.apiObject?.position?.details?.sos ? 'Triggered' :
                  'Normal' }}</span>
              </div>

              <div class="flex justify-between items-center px-4 py-3 border-b last:border-none">
                <span class="font-medium text-gray-500">GPS</span>
                <span class="text-gray-800 font-semibold">{{ d?.apiObject?.position?.details?.sat }} <span
                    class="font-normal">Satellites</span></span>
              </div>

              <div class="flex justify-between items-center px-4 py-3 border-b last:border-none">
                <span class="font-medium text-gray-500">Speed</span>
                <span class="text-gray-800 font-semibold">{{ d?.apiObject?.position?.details?.speed }} <span
                    class="font-normal">km/h</span></span>
              </div>

              <div class="flex justify-between items-center px-4 py-3 border-b last:border-none">
                <span class="font-medium text-gray-500">Odometer</span>
                <span class="text-gray-800 font-semibold">{{ d?.apiObject?.position?.details?.odometer }} <span
                    class="font-normal">km</span></span>
              </div>

              <div class="flex justify-between items-center px-4 py-3 border-b last:border-none">
                <span class="font-medium text-gray-500">Parking</span>
                <span class="text-gray-800 font-semibold">{{ d?.apiObject?.position?.details?.motion ? 'No' : 'Yes'
                  }}</span>
              </div>

              <div class="flex justify-between items-center px-4 py-3 border-b last:border-none">
                <span class="font-medium text-gray-500">Wheel Status</span>
                <span class="text-gray-800 font-semibold">{{ d?.apiObject?.position?.details?.motion ? 'Rolling' :
                  'Stationary' }}</span>
              </div>

              <div class="flex justify-between items-center px-4 py-3">
                <span class="font-medium text-gray-500">Immobilize</span>
                <span class="text-gray-800 font-semibold">{{ d?.apiObject?.position?.details?.blocked ? 'Yes' : 'No'
                  }}</span>
              </div>

            </ng-container>
          </div>
        </p-tabpanel>


      </p-tabpanels>
    </p-tabs>
  </div>

  <!-- Skeleton Loaders -->
  <ng-template #skeletonOverview>
    <div class="grid grid-cols-1 gap-4">
      <ng-container *ngFor="let i of [1, 2, 3, 4]">
        <p-skeleton height="40px" borderRadius="8px"></p-skeleton>
      </ng-container>
    </div>
  </ng-template>

  <ng-template #skeletonSensors>
    <div class="grid grid-cols-1 gap-4">
      <ng-container *ngFor="let i of [1, 2, 3, 4, 5, 6]">
        <p-skeleton height="40px" borderRadius="8px"></p-skeleton>
      </ng-container>
    </div>
  </ng-template>
</div>