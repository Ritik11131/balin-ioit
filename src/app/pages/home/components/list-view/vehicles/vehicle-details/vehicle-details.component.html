<div class="container mx-auto max-w-4xl h-full flex flex-col overflow-hidden">

  <!-- Vehicle Header -->
  <div class="flex justify-between items-center mb-6 shrink-0">
    <div class="flex items-center gap-3 group">
      <span [ngClass]="vehicle | vehicleStatus"
        class="relative w-2.5 h-2.5 rounded-full transition-all duration-300 group-hover:scale-110">
        <span [ngClass]="vehicle | vehicleStatus"
          class="absolute top-0 left-0 w-full h-full rounded-full opacity-75 animate-ping"></span>
      </span>
      <span class="text-lg font-semibold text-gray-800 group-hover:text-gray-900">
        {{ vehicle?.name || 'Loading...' }}
      </span>
    </div>
    <div>
      <p-button icon="pi pi-ellipsis-v" [outlined]="true" (click)="menu.toggle($event)"></p-button>
      <p-tieredMenu appendTo="body" #menu [model]="(menuItems$ | async) ?? []" [popup]="true"></p-tieredMenu>
    </div>
  </div>

  <!-- Tabs Section -->
  <div class="flex-1 overflow-hidden">
    <!-- Scrollable content above iframe -->
    <div class="text-sm pb-40"> <!-- add bottom padding to avoid overlap with iframe -->
      <ng-container *ngIf="vehicle; else skeletonOverview">

        <span class="text-lg font-semibold">
          Overview / Sensors Details
        </span>

        <!-- Updated -->
        <div class="flex justify-between items-center px-4 py-3 border-b border-gray-100">
          <span class="font-medium text-gray-500">Updated</span>
          <span class="text-gray-800 font-semibold">{{ vehicle.lastUpdated | timeAgo }}</span>
        </div>

        <!-- Address -->
        <div class="flex justify-between items-center px-4 py-3 border-b border-gray-100">
          <span class="font-medium text-gray-500">Address</span>
          <span class="text-gray-800 font-semibold">{{ vehicle.address || 'â€”' }}</span>
        </div>

        <!-- Speed -->
        <div class="flex justify-between items-center px-4 py-3 border-b border-gray-100">
          <span class="font-medium text-gray-500">Speed</span>
          <span class="text-gray-800">
            <span class="font-semibold">{{ vehicle?.apiObject?.position?.speed || 0 }}</span> km/h
          </span>
        </div>

        <!-- Odometer -->
        <div class="flex justify-between items-center px-4 py-3">
          <span class="font-medium text-gray-500">Odometer</span>
          <span class="text-gray-800">
            <span class="font-semibold">
              {{ ((vehicle?.apiObject?.device?.details?.lastOdometer) / 1000)?.toFixed(3) || 0 }}
            </span> km
          </span>
        </div>

        <div class="flex justify-between items-center px-4 py-3">
          <span class="font-medium text-gray-500">Odometer</span>
          <span class="text-gray-800">
            <span class="font-semibold">
              {{ ((vehicle?.apiObject?.device?.details?.lastOdometer) / 1000)?.toFixed(3) || 0 }}
            </span> km
          </span>
        </div>

        <div class="flex justify-between items-center px-4 py-3">
          <span class="font-medium text-gray-500">Odometer</span>
          <span class="text-gray-800">
            <span class="font-semibold">
              {{ ((vehicle?.apiObject?.device?.details?.lastOdometer) / 1000)?.toFixed(3) || 0 }}
            </span> km
          </span>
        </div>

        <div class="flex justify-between items-center px-4 py-3">
          <span class="font-medium text-gray-500">Odometer</span>
          <span class="text-gray-800">
            <span class="font-semibold">
              {{ ((vehicle?.apiObject?.device?.details?.lastOdometer) / 1000)?.toFixed(3) || 0 }}
            </span> km
          </span>
        </div>

        <div class="flex justify-between items-center px-4 py-3">
          <span class="font-medium text-gray-500">Odometer</span>
          <span class="text-gray-800">
            <span class="font-semibold">
              {{ ((vehicle?.apiObject?.device?.details?.lastOdometer) / 1000)?.toFixed(3) || 0 }}
            </span> km
          </span>
        </div>

        <div class="flex justify-between items-center px-4 py-3">
          <span class="font-medium text-gray-500">Odometer</span>
          <span class="text-gray-800">
            <span class="font-semibold">
              {{ ((vehicle?.apiObject?.device?.details?.lastOdometer) / 1000)?.toFixed(3) || 0 }}
            </span> km
          </span>
        </div>

        <div class="flex justify-between items-center px-4 py-3">
          <span class="font-medium text-gray-500">Odometer</span>
          <span class="text-gray-800">
            <span class="font-semibold">
              {{ ((vehicle?.apiObject?.device?.details?.lastOdometer) / 1000)?.toFixed(3) || 0 }}
            </span> km
          </span>
        </div>

        <div class="flex justify-between items-center px-4 py-3">
          <span class="font-medium text-gray-500">Odometer</span>
          <span class="text-gray-800">
            <span class="font-semibold">
              {{ ((vehicle?.apiObject?.device?.details?.lastOdometer) / 1000)?.toFixed(3) || 0 }}
            </span> km
          </span>
        </div>
        <div class="flex justify-between items-center px-4 py-3">
          <span class="font-medium text-gray-500">Odometer</span>
          <span class="text-gray-800">
            <span class="font-semibold">
              {{ ((vehicle?.apiObject?.device?.details?.lastOdometer) / 1000)?.toFixed(3) || 0 }}
            </span> km
          </span>
        </div>
      </ng-container>

      @if(iframeUrl) {
      <div class="fixed bottom-0 left-0 w-full max-w-4xl">
        <span class="text-lg font-semibold px-4 py-2">
          Live From Vehicle
        </span>
        <iframe [src]="iframeUrl" allow="microphone; camera; geolocation; autoplay; encrypted-media"
          class="w-full h-80 px-4" allowfullscreen loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
      } @else { 
         <div class="fixed bottom-0 left-0 w-full max-w-4xl bg-gray-100 border-t border-gray-300">
    <div class="flex flex-col items-center justify-center h-80 px-4 py-8">
      <!-- No Camera Vector Icon -->
      <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mb-4 text-gray-400">
        <path d="M2 6C2 4.89543 2.89543 4 4 4H9L10.5 2H13.5L15 4H20C21.1046 4 22 4.89543 22 6V18C22 19.1046 21.1046 20 20 20H4C2.89543 20 2 19.1046 2 18V6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <line x1="2" y1="2" x2="22" y2="22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      
      <h3 class="text-xl font-semibold text-gray-700 mb-2">No Camera Integrated</h3>
      <p class="text-gray-500 text-center max-w-sm">
        Camera functionality is not available for this protocol. Please check your vehicle's protocol or contact support.
      </p>
    </div>
  </div>
      }
    </div>
  </div>

  <!-- Skeleton Loaders -->
  <ng-template #skeletonOverview>
    <div class="grid grid-cols-1 gap-4">
      <ng-container *ngFor="let i of [1, 2, 3, 4]">
        <p-skeleton height="40px" borderRadius="8px"></p-skeleton>
      </ng-container>
    </div>
  </ng-template>

  <ng-template #skeletonSensors>
    <div class="grid grid-cols-1 gap-4">
      <ng-container *ngFor="let i of [1, 2, 3, 4, 5, 6]">
        <p-skeleton height="40px" borderRadius="8px"></p-skeleton>
      </ng-container>
    </div>
  </ng-template>
</div>