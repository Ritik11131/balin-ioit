<div class="relative">
    <!-- Loading overlay -->
    <div *ngIf="loading$ | async" class="absolute top-4 left-4 z-[1000] bg-white/95 backdrop-blur-sm p-3 rounded-lg shadow-lg border border-gray-200">
        <div class="flex items-center space-x-2">
            <div class="w-4 h-4 border-2 border-[var(--primary-color)] border-t-transparent rounded-full animate-spin"></div>
            <span class="text-sm text-gray-700 font-medium">Loading vehicles...</span>
        </div>
    </div>

    <!-- Search Input -->
    <!-- <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-[1000] w-80">
        <p-iconField iconPosition="left" class="w-full">
          <p-inputIcon>
            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </p-inputIcon>
          <input 
            pInputText 
            [(ngModel)]="searchTerm"
            (input)="onSearchChange($event)"
            placeholder="Search vehicles on map..." 
            class="w-full pl-10 pr-4 py-2 bg-white/95 backdrop-blur-sm border border-gray-200 rounded-lg shadow-lg focus:border-[var(--primary-color)] focus:ring-2 focus:ring-[var(--primary-color)]/20 transition-all duration-200"
          />
        </p-iconField>
      </div> -->

    <!-- Right side controls -->
    <div class="absolute top-4 right-4 z-[1000] flex flex-col space-y-3">
        <!-- Your Location Button -->
        <!-- <button 
          (click)="goToUserLocation()"
          [disabled]="gettingLocation"
          class="bg-white/95 backdrop-blur-sm hover:bg-[var(--primary-color)] hover:text-white disabled:opacity-50 p-3 rounded-lg shadow-lg border border-gray-200 transition-all duration-200 group"
          title="Go to your location">
          <svg *ngIf="!gettingLocation" class="w-5 h-5 text-gray-700 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          <div *ngIf="gettingLocation" class="w-5 h-5 border-2 border-[var(--primary-color)] border-t-transparent rounded-full animate-spin"></div>
        </button> -->

        <!-- Layer Switching Button -->
        <button (click)="switchMapLayer()" class="bg-white/95 backdrop-blur-sm hover:bg-[var(--primary-color)] hover:text-white p-3 rounded-lg shadow-lg border border-gray-200 transition-all duration-200 group" title="Switch map layer">
            <svg class="w-5 h-5 text-gray-700 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
                ></path>
            </svg>
        </button>

        <!-- Fit All Markers Button -->
        <!-- <button 
          (click)="fitAllMarkers()"
          class="bg-white/95 backdrop-blur-sm hover:bg-[var(--primary-color)] hover:text-white p-3 rounded-lg shadow-lg border border-gray-200 transition-all duration-200 group"
          title="Fit all vehicles">
          <svg class="w-5 h-5 text-gray-700 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
          </svg>
        </button> -->

        <!-- Toggle Clustering Button -->
        <!-- <button 
          (click)="toggleClustering()"
          [class]="clusteringEnabled ? 'bg-[var(--primary-color)] text-white' : 'bg-white/95 text-gray-700 hover:bg-[var(--primary-color)] hover:text-white'"
          class="backdrop-blur-sm p-3 rounded-lg shadow-lg border border-gray-200 transition-all duration-200 group"
          title="Toggle clustering">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
          </svg>
        </button> -->
    </div>

    @if (trackMapService.liveTrackingControlObj.visible) {
        <div cdkDrag class="fixed bottom-6 left-1/3 transform -translate-x-1/2 control-panel rounded-xl shadow-lg border border-gray-200 bg-white" style="width: 351px; z-index: 9999">
            <div cdkDragHandle class="drag-handle bg-gray-50 text-gray-700 px-4 py-2 rounded-t-xl flex items-center justify-between cursor-move border-b border-gray-100">
                <div class="flex items-center gap-2">
                    <i class="pi pi-bars text-xs text-gray-400"></i>
                    <span class="font-medium text-sm text-gray-600">Tracking Controls</span>
                </div>
            </div>

            <div class="p-4 space-y-4">
                <div>
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-2">
                            <span [ngClass]="trackMapService.liveTrackingControlObj | vehicleStatus" class="relative w-2.5 h-2.5 rounded-full transition-all duration-300 group-hover:scale-110">
                                <span [ngClass]="trackMapService.liveTrackingControlObj | vehicleStatus" class="absolute top-0 left-0 w-full h-full rounded-full opacity-75 animate-ping"></span>
                            </span>
                            <span class="text-sm font-semibold text-gray-800 transition-all duration-300 group-hover:text-gray-900">
                                {{ trackMapService.liveTrackingControlObj.vehicleName }}
                            </span>
                        </div>
                        <div class="flex gap-2">
                          <i class="pi pi-share cursor-pointer w-4 h-4 transition-all duration-300 
                                    hover:scale-110 active:scale-95 opacity-70 hover:opacity-100"></i>
                        
                          <i class="pi pi-history cursor-pointer w-4 h-4 transition-all duration-300 
                                    hover:scale-110 active:scale-95 opacity-70 hover:opacity-100"></i>
                        
                          <i class="pi pi-refresh cursor-pointer w-4 h-4 transition-all duration-300 
                                    hover:scale-110 active:scale-95 opacity-70 hover:opacity-100"></i>
                        </div>

                    </div>
                </div>                

                <!-- Row 3: Actions -->
                <div class="flex items-center gap-2">
                    <p-button [severity]="trackMapService.isFollowEnabled() ? 'danger' : 'secondary'" [label]="trackMapService.isFollowEnabled() ? 'Stop Following' : 'Follow Vehicle'"
                      [icon]="trackMapService.isFollowEnabled() ? 'pi pi-times' : 'pi pi-directions'" size="small"
                      (onClick)="toggleFollowVehicle()">
                    </p-button>
                    <p-button severity="contrast" label="Toggle Trail" [icon]="'pi pi-eye-slash'" (onClick)="toggleTrailVisibility()" size="small"> </p-button>
                    <p-button label="Exit Tracking" icon="pi pi-times" severity="danger" (onClick)="exitTracking()" size="small"></p-button>
                </div>
            </div>
        </div>
    }

    <div leaflet [leafletOptions]="options" (leafletMapReady)="onMapReady($event)" class="h-[calc(100vh-60px)] w-[calc(100vw-430px)] lg:w-[calc(100vw-430px)] lg:h-[calc(100vh-60px)]"></div>

    <!-- User location marker (hidden, used for animation) -->
    <div *ngIf="userLocationMarker" class="hidden"></div>
</div>
